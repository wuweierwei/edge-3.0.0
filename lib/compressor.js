/*! ander <anderpang@qq.com> 2016/3/15 */
"use strict";var spawn=require("child_process").spawn,fs=require("fs"),path=require("path"),stream=require("stream"),Readable=stream.Readable,Writable=stream.Writable,util=require("util"),zlib=require("zlib"),cssRule=require("./cssRule"),config=require("../config"),charset=config.charset||"utf8",jar;Function.prototype.method=function(a,b){return this.prototype[a]=b,this};function Reader(a){Readable.call(this,a)}util.inherits(Reader,Readable);Reader.method("_read",function(){}).method("writeFile",function(a,b){this.push(null);b?this.pipe(zlib.createGzip()).pipe(fs.createWriteStream(a+".gz")):this.pipe(fs.createWriteStream(a))});function getWriter(){var a=new Writable({write:function(b,d,c){this._data.push(b);c()}});a._data=[];a.toString=function(b){return Buffer.concat(this._data).toString(b||"utf8")};return a}fs.readdirSync(__dirname).some(function(a){if(path.extname(a)===".jar"){jar=path.join(__dirname,a);return true}});function compress(a,c,f,g){var e=path.join(a,"merge.json"),d,b=false;if(config.openMerge&&fs.existsSync(e)){d=require(e);d.forEach(function(h){if(h.indexOf(f)!=-1){b=true;_compressMulti(a,c,f,h,g)}})}b||_compressOne(path.join(a,f),path.join(c,f),g)}function _getCP(c,e,b){var a=["-jar",jar,"--charset",charset,"--type",c],d=spawn("java",a);d.stderr.on("data",function(f){console.log("process stderr:",f)});d.on("exit",function(){console.log("\x1b[32m Success\x1b[0m :",e,"->",b)});return d}function _cssDispose(b){var a=[];b=cssRule.keyframes.out(b,a);cssRule.rules.forEach(function(c){b=b.replace(c.reg,c.fn)});b=cssRule.keyframes.put(b,a);a=null;return b}function _dataListener(e,b,c){var d=new Reader(),a;if(c){a=new Reader();e.stdout.on("data",function(f){d.push(f);a.push(f)});e.stdout.on("end",function(){d.writeFile(b,false);a.writeFile(b,true)})}else{e.stdout.on("data",function(f){d.push(f)});e.stdout.on("end",function(){d.writeFile(b,false)})}}function _compressOne(f,b,c){var e,a=fs.createReadStream(f),d;if(c==="css"){d=getWriter();d.on("finish",function(){var g=_cssDispose(this.toString(charset)),h=_getCP(c,f,b);_dataListener(h,b,config.cssGzip);h.stdin.write(g);h.stdin.end()});a.pipe(d)}else{e=_getCP(c,f,b);_dataListener(e,b,config.jsGzip);a.on("end",function(){e.stdin.end()});a.pipe(e.stdin)}}function _compressMulti(i,b,c,g,j){var a=g.map(function(k){return path.basename(k)}).join(","),e=path.join(b,a),h=[],f=true,d;g.some(function(k){var l=path.join(i,k);if(k!==c&&!fs.existsSync(l)){f=false;d=l;return true}h.push(l)});if(!f){console.log("\x1b [31m Not found the file\x1b[0mï¼š",d);return}g=h.map(function(k){return new Promise(function(l){l(fs.createReadStream(k))})});Promise.all(g).then(function(n){var m,l,k;n.reverse();m=_getCP(j,"Merge",e);if(j==="css"){k=[];_dataListener(m,e,config.cssGizp);l=function(){var p=getWriter(),o;if(n.length){o=n.pop();p.on("finish",function(){k.push(this.toString(charset));l()});o.pipe(p)}else{k.forEach(function(q){m.stdin.write(_cssDispose(q))});m.stdin.end()}};l()}else{_dataListener(m,e,config.jsGzip);l=function(){var o;if(n.length){o=n.pop();o.on("end",l);o.pipe(m.stdin,{end:false})}else{m.stdin.end()}};l()}})}module.exports=compress;